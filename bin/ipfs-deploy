#!/usr/bin/env node

(async function() {
	// imported modules
	const CONSTANTS = require("./include/constants.js");
	const FileSystem = require("./include/FileSystem.js");
	const IPFS = require("./include/IPFS.js");
	const SSI = require("./include/SSI.js");

	// functions
	async function copyAllFiles() {
		await FileSystem.rm(CONSTANTS.DIR.IPFS, { force: true, recursive: true });
		const [addressesToCopy, filesToCopy] = await globalThis.Promise.all([FileSystem.readdir(CONSTANTS.DIR.WALLET.SOURCE), FileSystem.readdir(CONSTANTS.DIR)]);
		await FileSystem.mkdir(CONSTANTS.DIR.WALLET, { recursive: true });
		const copyPromises = filesToCopy.reduce((copyPromises, file) => {
			if (!CONSTANTS.FILES.EXCLUDED.includes(file) && !CONSTANTS.FILES.SSI.includes(file))
				copyPromises.push(FileSystem.copy(FileSystem.resolvePath(CONSTANTS.DIR, file), FileSystem.resolvePath(CONSTANTS.DIR.IPFS, file), { preserveTimestamps: true, recursive: true }));
			return copyPromises;
		}, []);
		addressesToCopy.reduce((copyPromises, file) => {
			copyPromises.push(FileSystem.copy(FileSystem.resolvePath(CONSTANTS.DIR.WALLET.SOURCE, file), FileSystem.resolvePath(CONSTANTS.DIR.WALLET, file), { preserveTimestamps: true, recursive: true }));
			return copyPromises;
		}, copyPromises);
		await globalThis.Promise.all(copyPromises);
	}

	// execution
	const ipfsKeyPromise = IPFS.KEY.fromName(CONSTANTS.IPFS.TARGET_KEY);
	const ipfsPriorCid = IPFS.NAME.resolve(ipfsKeyPromise);
	console.log(`copying files to ${CONSTANTS.DIR.IPFS}...`);
	await copyAllFiles();
	console.log("processing SSI directives...");
	await SSI.process();
	console.log("uploading to IPFS...");
	const cid = await IPFS.add();

	if (cid === await ipfsPriorCid) {
		console.log(`CID remains unchanged ${cid}`);
		return;
	}
	console.log(`uploaded to ${cid}`);
	await globalThis.Promise.all([
		(async () => console.log(`removing old pin and publishing new cid to /ipns/${await ipfsKeyPromise} ...`))(), 
		IPFS.NAME.publish(cid), 
		(async () => IPFS.PIN.rm(await ipfsPriorCid))()
	]);
})().catch(console.error);